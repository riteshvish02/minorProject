<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>WJAPS</title>
    <link rel="icon" href="/images/researchlogo.png" type="image/png">
    <link
    href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css"
    rel="stylesheet"/>
    <link rel="stylesheet" href="/stylesheets/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.2.0/ckeditor5.css" />
</head>
<body>
    <div class="parent w-full h-[100vh] bg-red-300 relative">
        <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
            <div class="alert absolute bottom-[10%] right-[10%] min-w-[20vh] max-w-[40vh] min-h-[8vh] rounded-md bg-[#B3DBAE] px-3 items-center gap-2 py-3 cursor-pointer flex">
                <img class="w-[4vh] h-[4vh] object-cover object-center" src="/images/icons/icons8-success-48.png" alt="">
               <h6><%= success_msg %></h6>
            </div>
        <% } %>

        <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
            <div class="alert absolute bottom-[10%] right-[10%] min-w-[20vh] max-w-[40vh] min-h-[8vh] rounded-md bg-red-200 px-3 items-center gap-2 py-3 cursor-pointer flex">
                <img class="w-[4vh] h-[4vh] object-cover object-center" src="/images/icons/icons8-close-window-48.png" alt="">
                <h6><%=error_msg%></h6>
            </div>
        <% } %>
        <div class="popup-warn xl:w-[40vh] hidden h-[20vh] ml-2  md:left-[20%] xl:left-[50%] top-[15%] xl:transform-x-[-50%]  bg-gray-200 shadow-md rounded-md cursor-pointer absolute">
            <p class="text-red-600 text-center pt-2 px-2">do you really want to delete this item?</p>
            <div class="div flex items-center justify-center w-full pt-10 gap-3">
                <h2 class="bg-blue-400 yes text-white xl:px-3 xl:py-[4px] rounded max-lg:p-2  lg:p-2 xl:text-[2.7vh] capitalize">
                    yes
                </h2>
                <h2 class="bg-red-400 no text-white xl:px-3 xl:py-[4px] rounded max-lg:p-2  lg:p-2 xl:text-[2.7vh] capitalize">
                    no
                </h2>
            </div>
        </div>
       <div class="navv h-[12vh] bg-[#FFFFFF] relative shadow-md border-b-[1.1px] px-[3.7vh] w-full flex items-center justify-between">
      <div class="left flex items-center px-3 max-lg:flex-col lg:gap-[8vh]">
        <img class="xl:w-[13vh] h-[5vh] w-[5vh] xl:h-[13vh] object-center object-cover" src="/images/login/loginpng-removebg-preview.png" alt="">
        <i class="ri-menu-line text-[2.8vh] menu-icon"></i>
      </div>
      <div class="right flex items-center gap-[2vh]">
        <img class="w-[7vh] h-[7vh] object-center object-cover" src="/images/researchlogo.png" alt="">
        <h1 class="text-zinc-900 profilenav">Admin <i class="ri-arrow-down-s-fill"></i></h1>
      </div>
     <div class="absolute w-[28vh] profilemenu hidden h-[15vh] bg-gray-100 flex flex-col items-start pl-5 right-[2%] shadow-md justify-center top-[100%]">
        <a class="text-black-600 font-medium capitalize" href="/admin/update-page/<%=adminId%>">
          <span><i class="ri-user-fill"></i></span>
          <span class="ml-3 lg:text-[2.2vh] max-lg:text-[2vh]">profile</span>
        </a>
        <a class="text-black-600 font-medium capitalize" href="/admin/update-passwordpage/<%=adminId%>">
          <span><i class="ri-refresh-fill"></i></span>
          <span class="ml-3 lg:text-[2.2vh] max-lg:text-[2vh]">update password</span>
        </a>
        <a class="text-red-600 font-medium capitalize" href="/admin/logout">
          <span><i class="ri-logout-box-line"></i></span>
          <span class="ml-3 lg:text-[2.2vh] max-lg:text-[2vh]">logout</span>
        </a>
      </div>
    </div>
        <div class="hero flex w-full h-[88vh] bg-gray-900 ">
            
            <div class="leftmenu dashboardleftmenu z-[9999] bg-gray-900 max-md:w-full max-lg:left-[-100%] xl:left-0 lg:left-[-100%] overflow-y-scroll form-scroll md:w-[70%]  lg:w-[30%] xl:w-[20%] max-lg:absolute lg:absolute xl:static h-[88vh] flex flex-col items-start pl-8 pt-[3vh]">
                <h1 class="text-white font-medium flex gap-3  text-[2.3vh]"><i class="ri-dashboard-line"></i> Dashboard</h1>
                <a href="/admin/manage-year" class="text-[#a6b0cf] hover:text-white w-[90%] hover:bg-gray-600 rounded-md py-3 flex items-center justify-start gap-3 mt-2 bg-zinc-800 px-2 capitalize cursor-pointer"><i class="ri-list-check text-[2.1vh] bg-gray-600 p-1 px-2  rounded-md"></i> <span>manage year</span></a>
                <a href="/admin/manage-issues" class="text-[#a6b0cf] hover:text-white w-[90%] hover:bg-gray-600 rounded-md py-3 flex items-center justify-start gap-3 mt-2 bg-zinc-800 px-2 capitalize cursor-pointer"><i class="ri-list-check text-[2.1vh] bg-gray-600 p-1 px-2  rounded-md"></i> <span>manage issues</span></a>
                <a href="/admin/manage-articles" class="text-[#a6b0cf] hover:text-white w-[90%] hover:bg-gray-600 rounded-md py-3 flex items-center justify-start gap-3 mt-2 bg-zinc-800 px-2 capitalize cursor-pointer"><i class="ri-list-check text-[2.1vh] bg-gray-600 p-1 px-2  rounded-md"></i> <span>manage article</span></a>
                <a href="/admin/manage-indexing" class="text-[#a6b0cf] hover:text-white w-[90%] hover:bg-gray-600 rounded-md py-3 flex items-center justify-start gap-3 mt-2 bg-zinc-800 px-2 capitalize cursor-pointer"><i class="ri-list-check text-[2.1vh] bg-gray-600 p-1 px-2  rounded-md"></i> <span>manage index</span></a>
                <a href="/admin/manage-news" class="text-[#a6b0cf] hover:text-white w-[90%] hover:bg-gray-600 rounded-md py-3 flex items-center justify-start gap-3 mt-2 bg-zinc-800 px-2 capitalize cursor-pointer"><i class="ri-list-check text-[2.1vh] bg-gray-600 p-1 px-2  rounded-md"></i> <span>manage news</span></a>
                <a href="/admin/manage-contactus" class="text-[#a6b0cf] hover:text-white w-[90%] hover:bg-gray-600 rounded-md py-3 flex items-center justify-start gap-3 mt-2 bg-zinc-800 px-2 capitalize cursor-pointer"><i class="ri-list-check text-[2.1vh] bg-gray-600 p-1 px-2  rounded-md"></i> <span>manage contact us</span></a>
                <a href="/admin/manage-editorial" class="text-[#a6b0cf] hover:text-white w-[90%] hover:bg-gray-600 rounded-md py-3 flex items-center justify-start gap-3 mt-2 bg-zinc-800 px-2 capitalize cursor-pointer"><i class="ri-list-check text-[2.1vh] bg-gray-600 p-1 px-2  rounded-md"></i> <span>manage editorial</span></a>
                <a href="/admin/manage-subscript" class="text-[#a6b0cf] hover:text-white w-[90%] hover:bg-gray-600 rounded-md py-3 flex items-center justify-start gap-3 mt-2 bg-zinc-800 px-2 capitalize cursor-pointer"><i class="ri-list-check text-[2.1vh] bg-gray-600 p-1 px-2  rounded-md"></i> <span>manage manuscript</span></a>
              </div>
          <div class="right h-[88vh] max-lg:w-full lg:w-full  xl:w-[80%] bg-[#F8F8FB] px-4 pt-4 overflow-scroll ">
           
            <div class="top-section flex justify-between w-full mb-4">
                <h2 class="uppercase text-zinc-900 text-[2.5vh] max-md:text-[2vh] font-bold">manuscript</h2>
                <h3 class="text-zinc-600 ml-5">Dashboard / <span class="text-zinc-500">manuscript</span></h3>
            </div>
            <div class="list bg-white w-fit mt-7 rounded-md p-3 ">
               <div class="head-search flex w-[70vw] items-center justify-between">
                <div class="search flex flex-col pr-[15vh]">
                    <label class="text-zinc-800 text-[2.4vh] capitalize font-medium" for="">search:</label>
                    <input id="searchInput" class="w-[27vh] border-[1.8px] border-gray-400 px-2 py-[4px] rounded-md" type="text" placeholder="Search..." oninput="handleSearch()">
                </div>
               </div>
               <div  class="data-editorials w-fit border-[1.2px] mt-3   border-zinc-400 ">
                    <div class="row1 shrink-0  w-full flex capitalize h-[5vh]">
                        <div class="col1 flex items-center pl-2 w-[5vh] border-r-[1.2px] border-zinc-400">
                            <h2>#</h2>
                        </div>
                        <div class="col1 shrink-0 w-[23vh] border-r-[1.2px] border-zinc-400 flex items-center pl-2">
                            <h2>Number</h2>
                        </div>
                        <div class="col1 shrink-0 w-[23vh] border-r-[1.2px] border-zinc-400 flex items-center pl-2">
                            <h2>type</h2>
                        </div>
                        <div class="col1 shrink-0 w-[23vh] border-r-[1.2px] border-zinc-400 flex items-center pl-2">
                            <h2>title</h2>
                        </div>
                        <div class="col1 shrink-0 w-[30vh] border-r-[1.2px] border-zinc-400 flex items-center pl-2">
                            <h2>name </h2>
                        </div>
                        <div class="col1 shrink-0 w-[42vh] border-r-[1.2px] border-zinc-400 flex items-center pl-2">
                            <h2>email</h2>
                        </div>
                        
                        <div class="col1 shrink-0 w-[25vh] border-r-[1.2px] border-zinc-400 flex items-center pl-2">
                            <h2>status</h2>
                        </div>
                        <div class="col1 shrink-0 w-[15vh] border-r-[1.2px] border-zinc-400 flex items-center pl-2">
                            <h2>file</h2>
                        </div>
                        <div class="col1 shrink-0 w-[15vh] border-r-[1.2px] border-zinc-400 flex items-center pl-2">
                            <h2>Action</h2>
                        </div>
                    
                       
                    </div>
                    <div id="content">
                       
                    </div>
               </div>
               <div id="pagination" class="pagination mt-4 flex justify-center gap-2">
               
              </div>
           
            </div>
          </div>
        </div>
    
      </div>
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"
      integrity="sha512-16esztaSRplJROstbIIdwX3N97V1+pZvV33ABoG1H2OyTttBxEGkTsoIVsiP1iaTtM8b3+hu2kB6pQ4Clr5yug=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      
      <script>
         const menu = document.querySelector(".leftmenu")
          let toggle = 0;
       document.querySelector(".menu-icon").addEventListener("click", function(e) {
        if(toggle == 0){
            gsap.to(menu,{
                left:"0",
                duration: 0.5,
                ease: "power3.inOut"
            })
            toggle = 1;
        }else{
            gsap.to(menu,{
                left:"-100%",
                duration: 0.5,
                ease: "power3.inOut"
            })
            toggle = 0;
        }
       })
      
 let toggler = 0;
      let prof = document.querySelector(".profilenav")
       prof.addEventListener("click",()=>{
        if(toggler == 0){
          document.querySelector(".profilemenu").classList.remove("hidden")
          toggler = 1;
        }else{
          document.querySelector(".profilemenu").classList.add("hidden")
          toggler = 0;
        }
       })
    
    setTimeout(function() {
        const alert = document.querySelector('.alert');
        if (alert) {
        alert.style.display = 'none';
        }
    }, 3000);
    let currentPage = 1;        // Current page
    let totalPages = 0;         // Total number of pages
    const itemsPerPageView = 2; // Number of page numbers to show in pagination
    let searchTerm = '';        // Current search term
    
    // Load editorials with pagination and search term
    function loadPage(page = 1) {
        const url = `/admin/get-manuscript?page=${page}&search=${searchTerm}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                
                const { subscripts, totalPages: total, currentPage: current } = data;
                totalPages = total;
                currentPage = current;
    
                // Update the editorial content
                const contentDiv = document.getElementById('content');
                contentDiv.innerHTML = '';  // Clear the existing content
                
                // Render editorials (or data)
                subscripts.forEach((editorial, index) => {
                    const Template = `
                     <div class="row1 border-t-[1.2px] border-gray-500 bg-[#F7F9FC] shrink-0  w-full flex  ">
                            <div class="col1  form-scroll  flex items-start pl-2 w-[5vh] border-r-[1.2px] border-zinc-400">
                                <h2 class="m-3">
                                    ${index+1}
                                </h2>
                            </div>
                            
                            <div  class="col1    shrink-0 w-[23vh] border-r-[1.2px] border-zinc-400 flex items-start pl-2">
                                <h2 class="m-3 text-blue-800 font-bold">${editorial.manuscriptNumber}</h2>
                            </div>
                            <div  class="col1    shrink-0 w-[23vh] border-r-[1.2px] border-zinc-400 flex items-start pl-2">
                                <h2 class="m-3">${editorial.articletype}</h2>
                            </div>
                            <div  class="col1    shrink-0 w-[23vh] border-r-[1.2px] border-zinc-400 flex items-start pl-2">
                                <h2 class="m-3">${editorial.title}</h2>
                            </div>
                            <div  class="col1    shrink-0 w-[30vh] border-r-[1.2px] border-zinc-400 flex items-start pl-2">
                                <h2 class="m-3">${editorial.name}</h2>
                            </div>
                            <div  class="col1    shrink-0 w-[42vh] border-r-[1.2px] border-zinc-400 flex items-start pl-2">
                                <h2 class="m-3">${editorial.email}</h2>
                            </div>
                           
                                <div  class="col1    shrink-0 w-[25vh] border-r-[1.2px] border-zinc-400 flex flex-col items-start pl-2">

                                <h2 class="m-3 ${
                                  editorial.status == 'Rejected' ? 'bg-red-500' : editorial.status == 'Pending' ? 'bg-[#F1B44C]' :editorial.status == 'Accepted' ? 'bg-green-400': 'bg-blue-500'
                                } capitalize px-3 py-1 text-[2.3vh] text-white font-medium rounded-md">${editorial.status}</h2>
                                <form class="forem" data-val='${editorial._id}' method='post'">
                                    <select class="outline-none border-[1.5px] border-zinc-700 rounded-md py-[6px] ml-3 w-[15vh] px-2 mb-2 cursor-pointer" name="status" id="status">
                                             <option value="" disabled selected>select</option>
                                            <option class="py-[5px] opts cursor-pointer" value="Pending">Pending</option>
                                            <option class="py-[5px] opts cursor-pointer" value="Accepted">Accepted</option>
                                            <option class="py-[5px] opts cursor-pointer" value="Rejected">Rejected</option>
                                            <option class="py-[5px] opts cursor-pointer" value="Under Review">Under Review</option>
                                    </select>
                                </form>
                            </div>
                             <div  class="col1    shrink-0 w-[15vh] border-r-[1.2px] border-zinc-400 flex items-start pl-2 overflow-x-hidden form-scroll">
                                <a class="capitalize bg-[#F1B44C] px-3 my-3 py-1 text-[1.7vh] font-medium rounded-md text-white " href="/admin/manuscript-download/${editorial._id}">download</a>
                            </div>
                            <div  class="col1  overscroll  shrink-0 w-[15vh] border-r-[1.2px] border-zinc-400 flex items-start pl-2">
                                <h2 id="delete" data-val="${editorial._id}" class="text-[2.5vh] py-[4px] m-3 px-2 rounded-sm bg-red-400 cursor-pointer">
                                    <i  class="ri-delete-bin-6-line"></i>
                                </h2>
                            </div>
                        
                           
                        </div>
                    `
                    contentDiv.innerHTML += Template; // Append each editorial row
                    deletepopup()
                    setupFormHandlers();

                });
    
                // Update pagination
                const and = updatePagination();
                console.log(and);
                
            });
    }
    
    // Handle Search
    function handleSearch() {
        const searchInput = document.getElementById('searchInput');
        searchTerm = searchInput.value; // Update the search term
        loadPage(1); // Reload from the first page when searching
    }
    
    // Update Pagination
    function updatePagination() {
        const paginationDiv = document.getElementById('pagination');
        paginationDiv.innerHTML = '';  // Clear the pagination
    
        const startPage = Math.max(1, currentPage - Math.floor(itemsPerPageView / 2));
        const endPage = Math.min(totalPages, startPage + itemsPerPageView - 1);
    
        // Add previous button
        if (currentPage > 1) {
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.onclick = () => loadPage(currentPage - 1);
            paginationDiv.appendChild(prevButton);
        }
    
        // Add page buttons
        for (let page = startPage; page <= endPage; page++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = page;
            if (currentPage === page) {
                pageButton.classList.add('active'); // Only add the class if the page matches
            }
            pageButton.onclick = () => loadPage(page);
            paginationDiv.appendChild(pageButton);
        }
    
        // Add next button
        if (currentPage < totalPages) {
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.onclick = () => loadPage(currentPage + 1);
            paginationDiv.appendChild(nextButton);
        }
    }
    
    // Initially load the first page
    loadPage();
    
    
    
    
    function deletepopup(){
        document.querySelectorAll("#delete").forEach(function(elem){
        const yes = document.querySelector(".popup-warn .yes")
        const no = document.querySelector(".popup-warn .no")
        let index = 1;
          elem.addEventListener("click", function(){
            if(index == 1){
                document.querySelector(".popup-warn").classList.remove("hidden");
                index = 0;
                console.log(elem.dataset.val);
                yes.addEventListener("click",()=>{
                    fetch(`/admin/manuscript-delete/${elem.dataset.val}`,{
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then((response)=>{
                        const res =  response.json();
                        res.then((response)=>{
                            if (response.success) {  // You can check for success or other conditions in the response
                            window.location.href = "/admin/manage-subscript"; // Redirect to a success page
                            } else {
                            // Handle error or failure case here
                            console.log("Deletion failed:", response.message);
                           }
                        })
                    })
                })
                no.addEventListener("click",()=>{
                    document.querySelector(".popup-warn").classList.add("hidden");
                    index = 1;
                })
            }else{
                document.querySelector(".popup-warn").classList.add("hidden");
                index = 1;
            }
        })
        })
        }
        deletepopup();
        function setupFormHandlers() {
    // Get all select elements within forms with class 'forem'
    document.querySelectorAll('.forem select').forEach(select => {
        select.addEventListener('change', async function(e) {
            e.preventDefault();
            const form = this.closest('.forem');
            const manuscriptId = form.dataset.val; // Get the manuscript ID from the form's dataset attribute
            
            const status = this.value;

            try {
                const response = await fetch(`/admin/manuscript-status/${manuscriptId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                const data = await response.json();

                if (data.success) {
                    // Reload the current page to show updated status
                    window.location.reload();
                } else {
                    console.error('Status update failed:', data.message);
                    // Optionally show an error message to the user
                    alert('Failed to update status. Please try again.');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('An error occurred while updating status.');
            }
        });
    });
}

// Add this line in the loadPage function after the content is updated
// Right after the deletepopup() call:
setupFormHandlers();

</script> 
</body>
</html>